{% extends "base.html" %}
{% load static %}
{% load format_date %}
{% load vote_status %}
{% load tz %}

{% block content %}

      <h2 class="page-header">[<a href="{{document_url}}">{{document.title}}</a>] {{ question.title }}</h2>
      <div class="row">
        <div class="parent-post col-lg-36">
          <div class='editable-comment'>
              {% include "post.html" with post_type="question" post=question user=user %}
          </div>
          <hr class="thin">

        </div>
        <div class="replies col-xs-34 col-xs-offset-2">
          {% for reply in question.replies.all %}
              {% include "post.html" with post_type="reply" post=reply %}

              <hr class="thin">
          {% endfor %}

          <input class="slug" type="hidden" value='{{ question.slug }}'>
          <a class='add-comment'>add a comment</a>
        </div>
      </div>

      <h2 class="page-header">Answers
        <div class="dropdown dropdown-text pull-right">
          <a href="#" data-toggle="dropdown" class="dropdown-toggle">Sort by <b class="caret"></b></a>
          <ul class="dropdown-menu">
            <li><a href="#"><i class="fa fa-comments-o fa-fw"></i> Active</a></li>
            <li><a href="#"><i class="fa fa-clock-o fa-fw"></i> Oldest</a></li>
            <li><a href="#"><i class="fa fa-thumbs-o-up fa-fw"></i> Votes</a></li>
          </ul>
        </div>
      </h2>

      <div id="answers">
        {% for answer in answers %}
          <div class="row">
            <div class="parent-post col-lg-36">
              <div class='editable-comment'>
                  {% include "post.html" with post_type="answer" post=answer user=user %}
              </div>
              <hr class="thin">
            </div>

            <div class="replies col-xs-34 col-xs-offset-2">
              {% for reply in answer.replies.all %}
                  {% include "post.html" with post_type="reply" post=reply %}
                  <hr class="thin">
              {% endfor %}

              <input class="slug" type="hidden" value='{{ answer.slug }}'>
              <a class='add-comment'>add a comment</a>
            </div>
          </div>
          <hr class="dark">

        {% empty %}
          <div class="container-fluid"><h4>there are no answers yet...</h4></div>
          <hr class="dark">
        {% endfor %}
      </div>

      <div class="row-fluid">
        <h4>Add an answer</h4>
      </div>

      <div id="your_answer">
          <form method="POST">{% csrf_token %}
          <div class="row-fluid">
                {{ACForm.content}}
          </div>
          <div class="row-fluid">
            <button onclick="removeRequired()" name="createAnswerSubmit" type="submit" class="btn btn-primary pull-right" style="margin-top: 10px;">Post your answer</button>
          </div>
          </form>
      </div>

      <!-- Report Modal HTML -->
      <div id="report-modal" class="modal fade">
        <div class="modal-dialog" style="width: 300px; margin: 30px auto;">
            <div class="modal-content">
              <div class="modal-body">
                  <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                  <div class="container-fluid">

                      <h3 class="modal-title">Report this post</h3>
                      <hr>
                      Select the reason(s) you found to report this post:
                      <div class="checkbox">
                        <label><input type="checkbox" value="">Inappropriate imagery</label>
                      </div>
                      <div class="checkbox">
                        <label><input type="checkbox" value="">URL shortener</label>
                      </div>
                      <div class="checkbox">
                        <label><input type="checkbox" value="">Spam</label>
                      </div>
                      <div class="checkbox">
                        <label><input type="checkbox" value="">Harassment, hate speech, or verbal abuse</label>
                      </div>
                  </div>
              <hr>
              <div class="row-fluid clearfix">
                  <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-danger pull-right"><i class="fa fa-flag fa-fw"></i> Report</button>
              </div>
            </div>

          </div>
        </div>
      </div>

{% endblock %}

{% block scripts %}
    <script src="{% static "js/tinymce/tinymce.min.js" %}"></script>
    <script>
      tinymce.init({
        selector: 'textarea',
        height: 100,
        theme: 'modern',
        removed_menuitems: 'newdocument',
        plugins: [
          'advlist autolink lists link image charmap preview hr',
          'searchreplace code eqneditor',
          'insertdatetime save table directionality',
          'paste textpattern imagetools'
        ],
        toolbar1: 'bold italic | alignleft aligncenter alignright alignjustify | bullist numlist | outdent indent | link image eqneditor',
      });
    </script>
    <script>
      $( ".replies" ).each(function() {
        if ($(this).children(".row-fluid").length > 5) {
          // get count ofo number of children
          var replyNumber = $(this).children(".row-fluid").length - 5;
          // hide the other elements
          $(this).children(":gt(9)").hide();

          // create new expand button
          $(this).append("<a class='show-comments'>show <b>"+replyNumber+"</b> more comments </a>");
        }
      });
    </script>
    <script>
      $(function() {
        $(document).on('click', '.show-comments', function() {
          $(this).parent().children(":gt(9)").show();
          $(this).remove();
        });
      });
    </script>

    <script>
      var questionTotal = 1;

      function create_tinymce(post_type, slug) {
        if (post_type == 'reply') {
          submit_btn_name = 'createReplySubmit';
        } else {
          submit_btn_name = 'editPostSubmit';
        }

        new_tinymce = '<div class="reply-content row-fluid">'+
        "<form method='POST' style='display: inline'>{% csrf_token %}" +
        '<textarea name="content" id="'+textareaId+'"></textarea>'+
        '<div class="row-fluid clearfix">'+
        '<button type=button class="btn btn-sm btn-default btn-cancel-edit pull-left" style="margin-top: 10px;">'+
        'Cancel'+
        '</button>'+
        '<button value='+slug+' name='+submit_btn_name+' onclick="tinyMCE.triggerSave(); removeRequired();" type="submit" class="btn btn-sm btn-success pull-right" style="margin-top: 10px;">'+
        'Save changes'+
        '</button>'+
        '</div>'+
        '</form>' +
        '</div>';

        return new_tinymce
      }

      /* FOR QUESTION AND ANSWER EDITING */
      $(document).on('click', '.edit-comment', function(e) {
          questionTotal += 1;
          textareaId = "mceId"+questionTotal;
          slug = $(this).siblings('.slug').val()
          closest_editable =  $(this).closest('.editable-comment');
          $(closest_editable).after(create_tinymce('non-reply', slug));

          tinymce.EditorManager.execCommand('mceAddEditor', true, textareaId);
          // populate it with existing content
          tinyMCE.get( textareaId).setContent($(closest_editable).find('.rich-text').html());
          $(closest_editable).hide();

      });

      $(document).on('click', '.btn-cancel-edit', function(e) {
        $(this).closest('.parent-post').find('.editable-comment').show();

        tinymce.EditorManager.execCommand('mceRemoveEditor',true, $(this).closest('.parent-post').find('textarea').attr('id'));
        $(this).closest('.reply-content').remove();
      });

      /* FOR REPLIES */
      $(document).on('click', '.add-comment', function(e) {
          questionTotal += 1;
          textareaId = "mceId"+questionTotal;
          slug = $(this).siblings('.slug').val()
          // add new blank reply
          $(this).closest('.replies').append(create_tinymce('reply', slug));

          tinymce.EditorManager.execCommand('mceAddEditor', true, textareaId);
          $(this).hide();

      });

      $(document).on('click', '.btn-cancel-reply', function(e) {
        $(this).closest('.replies').find('.add-comment').show();

        tinymce.EditorManager.execCommand('mceRemoveEditor',true, $(this).closest('.reply-content').find('textarea').attr('id'));
        $(this).closest('.reply-content').remove();
      });

    </script>

    <script>
    function removeRequired() {
       /* Remove the 'required' field for the hidden input textarea
        * not doing so will pick up an unavoidable error for validating the textarea
        */
        $("textarea").removeAttr("required");
    }
    </script>
{% endblock %}
