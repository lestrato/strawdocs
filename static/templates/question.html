{% extends "base.html" %}
{% load static %}
{% load format_date %}
{% load vote_status %}
{% load tz %}

{% block content %}
      <h2 class="page-header">[<a href="{{document_url}}">{{document.title}}</a>] {{ question.title }}</h2>
    <div id="posts">
      <div class="row">
        <div class="parent-post col-lg-36">
          <div class='editable-comment'>
              {% include "post.html" with post_type="question" post=question user=user %}
          </div>
          <hr class="thin">

        </div>
        <div class="replies col-xs-34 col-xs-offset-2">
          {% for reply in question.replies.all %}
              {% include "post.html" with post_type="reply" post=reply %}

              <hr class="thin">
          {% endfor %}

          <input class="slug" type="hidden" value='{{ question.slug }}'>
          {% if not user.is_anonymous %}
            <a class='add-comment'>add a comment</a>
          {% else %}
            <div><a href="#login" data-toggle="modal">log in</a> to reply</div>
          {% endif %}
        </div>
      </div>

      <h2 class="page-header">Answers
        <div class="dropdown dropdown-text pull-right">
          <a href="#" data-toggle="dropdown" class="dropdown-toggle">Sort by <b class="caret"></b></a>
          <ul class="dropdown-menu">
            <li><a href="?sortby=active#answers"><i class="fa fa-comments-o fa-fw"></i> Active</a></li>
            <li><a href="?sortby=newest#answers"><i class="fa fa-clock-o fa-fw"></i> Newest</a></li>
            <li><a href="?sortby=votes#answers"><i class="fa fa-thumbs-o-up fa-fw"></i> Votes</a></li>
          </ul>
        </div>
      </h2>
      <div id="answers">
          {% for answer in answers %}
            <div class="row">
              <div class="parent-post col-lg-36">
                <div class='editable-comment'>
                    {% include "post.html" with post_type="answer" post=answer user=user %}
                </div>
                <hr class="thin">
              </div>

              <div class="replies col-xs-34 col-xs-offset-2">
                {% for reply in answer.replies.all %}
                    {% include "post.html" with post_type="reply" post=reply %}
                    <hr class="thin">
                {% endfor %}

                <input class="slug" type="hidden" value='{{ answer.slug }}'>
                {% if not user.is_anonymous %}
                  <a class='add-comment'>add a comment</a>
                {% else %}
                  <div><a href="#login" data-toggle="modal">log in</a> to reply</div>
                {% endif %}
              </div>
            </div>
            <hr class="dark">

          {% empty %}
            <div class="container-fluid"><h4>there are no answers yet...</h4></div>
            <hr class="dark">
          {% endfor %}
      </div>
    </div>

    {% if not user.is_anonymous %}
      <div class="row-fluid">
        <h4>Add an answer</h4>
      </div>
    {% else %}
      <div class="row-fluid">
        <h4><a href="#login" data-toggle="modal">log in</a> to answer</h4>
      </div>
    {% endif %}

    <div id="your_answer">
        <form method="POST" id="create-answer-form">{% csrf_token %}
        <div class="row-fluid">
              {{ACForm.content}}
        </div>
        <div class="row-fluid">
          <input type="hidden" name="createAnswerSubmit">
          <button onclick="removeRequired()" type="submit" class="btn btn-primary pull-right {% if user.is_anonymous %}disabled{% endif %}" style="margin-top: 10px;">Post your answer</button>
        </div>
        </form>
      </div>
    <!-- Report Modal HTML -->
    <div id="report-modal" class="modal fade">
      <div class="modal-dialog" style="width: 300px; margin: 30px auto;">
          <div class="modal-content">
            <div class="modal-body">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <div class="container-fluid">

                    <h3 class="modal-title">Report this post</h3>
                    <hr>
                    Select the reason(s) you found to report this post:
                    <div class="checkbox">
                      <label><input type="checkbox" value="">Inappropriate imagery</label>
                    </div>
                    <div class="checkbox">
                      <label><input type="checkbox" value="">URL shortener</label>
                    </div>
                    <div class="checkbox">
                      <label><input type="checkbox" value="">Spam</label>
                    </div>
                    <div class="checkbox">
                      <label><input type="checkbox" value="">Harassment, hate speech, or verbal abuse</label>
                    </div>
                </div>
            <hr>
            <div class="row-fluid clearfix">
                <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger pull-right"><i class="fa fa-flag fa-fw"></i> Report</button>
            </div>
          </div>

        </div>
      </div>
    </div>

{% endblock %}

{% block scripts %}
<script type="text/javascript" src="{% static "js/tinymce/tinymce.min.js" %}"></script>
<script type="text/javascript">
  tinymce.init({
    {% if user.is_anonymous %}readonly : 1,{% endif %}
    selector: 'textarea',
    height: 100,
    theme: 'modern',
    removed_menuitems: 'newdocument',
    plugins: [
      'advlist autolink lists link image charmap preview hr',
      'searchreplace code eqneditor',
      'insertdatetime save table directionality',
      'paste textpattern imagetools'
    ],
    toolbar1: 'bold italic | alignleft aligncenter alignright alignjustify | bullist numlist | outdent indent | link image eqneditor',
  });
</script>
<!-- <script type="text/javascript" src="{% static "js/initiate-tinymce.js" %}"></script> -->
<script type="text/javascript" src="{% static "js/show-all-comments.js" %}"></script>
<script type="text/javascript" src="{% static "js/remove-required.js" %}"></script>
<script type="text/javascript" src="{% static "js/ajax.js" %}"></script>

<script type="text/javascript">
  var questionTotal = 1;

  function create_tinymce(post_type, slug) {
    if (post_type == 'reply') {
      cancel_btn_name = 'btn-cancel-reply';
      submit_btn_name = 'createReplySubmit';
      form_name = 'createReplyForm';
    } else {
      cancel_btn_name = 'btn-cancel-edit';
      submit_btn_name = 'editPostSubmit';
      form_name = 'editPostForm';
    }

    new_tinymce = '<div class="reply-content row-fluid">'+
    "<form method='POST' style='display: inline' class="+form_name+">{% csrf_token %}" +
    '<textarea name="content" id="'+textareaId+'"></textarea>'+
    '<div class="row-fluid clearfix">'+
    '<button type=button class="btn btn-sm btn-default ' + cancel_btn_name +' pull-left" style="margin-top: 10px;">'+
    'Cancel'+
    '</button>'+
    '<input type="hidden" name='+submit_btn_name+' value='+slug+'>' +
    '<button onclick="removeRequired();" type="submit" class="btn btn-sm btn-success pull-right" style="margin-top: 10px;">'+
    'Save changes'+
    '</button>'+
    '</div>'+
    '</form>' +
    '</div>';

    return new_tinymce
  }

  /* FOR QUESTION AND ANSWER EDITING */
  $(document).on('click', '.edit-comment', function(e) {
      questionTotal += 1;
      textareaId = "mceId"+questionTotal;
      slug = $(this).siblings('.slug').val()
      closest_editable =  $(this).closest('.editable-comment');
      $(closest_editable).after(create_tinymce('non-reply', slug));

      tinymce.EditorManager.execCommand('mceAddEditor', true, textareaId);
      // populate it with existing content
      tinyMCE.get( textareaId).setContent($(closest_editable).find('.rich-text').html());
      $(closest_editable).hide();

  });

  $(document).on('click', '.btn-cancel-edit', function(e) {
    $(this).closest('.parent-post').find('.editable-comment').show();

    tinymce.EditorManager.execCommand('mceRemoveEditor',true, $(this).closest('.parent-post').find('textarea').attr('id'));
    $(this).closest('.reply-content').remove();
  });

  /* FOR REPLIES */
  $(document).on('click', '.add-comment', function(e) {
      questionTotal += 1;
      textareaId = "mceId"+questionTotal;
      slug = $(this).siblings('.slug').val()
      // add new blank reply
      $(this).closest('.replies').append(create_tinymce('reply', slug));

      tinymce.EditorManager.execCommand('mceAddEditor', true, textareaId);
      $(this).hide();

  });

  $(document).on('click', '.btn-cancel-reply', function(e) {
    $(this).closest('.replies').find('.add-comment').show();

    tinymce.EditorManager.execCommand('mceRemoveEditor',true, $(this).closest('.reply-content').find('textarea').attr('id'));
    $(this).closest('.reply-content').remove();
  });
</script>
<script type="text/javascript">
  $(document).on('submit', '#create-answer-form', function(event) {
      // AJAX for submitting answers
      event.preventDefault();
      {% if user.is_anonymous %}
        $("#login").modal("show");
      {% else %}
        ajax_post($(this), "#answers", "#answers", 'tinymce');
      {% endif %}
  });

  $(document).on('click', ".createReplyForm", function(event){
    // AJAX for submitting replies
    event.preventDefault();
    form = $(this).closest('form');
    ajax_post(form, "#posts", "#posts", "tinymce");
  });

  $(document).on('click', ".editPostForm", function(event){
    // AJAX for submitting replies
    event.preventDefault();
    form = $(this).closest('form');
    ajax_post(form, "#posts", "#posts", "tinymce");
  });

  $(document).on('submit', ".vote-submit", function(event) {
    // AJAX for submitting upvotes/downvotes
    event.preventDefault();
    {% if user.is_anonymous %}
      $("#login").modal("show");
    {% else %}
      ajax_post($(this), $(this).closest('.btn-group-xs'), ".btn-group-xs", 'None');
    {% endif %}
  });
</script>
<script type="text/javascript">
  $( ".replies" ).each(function() {
    if ($(this).children(".row-fluid").length > 5) {
      // get count ofo number of children
      var replyNumber = $(this).children(".row-fluid").length - 5;
      // hide the other elements
      $(this).children(":gt(14)").hide();

      // create new expand button
      $(this).append("<div class='show-comments'><a>show <b>"+replyNumber+"</b> more comments </a></div>");
    }
  });

  $(document).on('click', '.show-comments', function() {
    $(this).parent().children(":gt(14)").show();
    $(this).remove();
  });

</script>
{% endblock %}
